services:
  nats:
    image: nats:latest
    command: ["-js"]
    ports:
      - "4222:4222"

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: trinity
      POSTGRES_USER: trinity
      POSTGRES_PASSWORD: trinity
    ports:
      - "5432:5432"

  neo4j:
    image: neo4j:5-community
    environment:
      NEO4J_AUTH: neo4j/trinity123
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
    ports:
      - "7474:7474"
      - "7687:7687"
    restart: always

  event-collector:
    build:
      context: .
      dockerfile: services/event-collector/Dockerfile
    environment:
      NATS_URL: nats://nats:4222
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
    ports:
      - "8001:8000"
    restart: always

  kg-projector:
    build:
      context: .
      dockerfile: services/kg-projector/Dockerfile
    environment:
      NATS_URL: nats://nats:4222
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: trinity123
    restart: always

  rca-api:
    build:
      context: .
      dockerfile: services/rca-api/Dockerfile
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: trinity123
    ports:
      - "8002:8000"
    restart: always

  investigation-api:
    build:
      context: .
      dockerfile: services/investigation-api/Dockerfile
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: trinity123
      RCA_API_URL: http://rca-api:8000
    ports:
      - "8003:8000"
    restart: always

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    restart: always

  vector-search:
    build:
      context: .
      dockerfile: services/vector-search/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "8004:8000"
    restart: always
    depends_on:
      - redis

  notification-service:
    build:
      context: .
      dockerfile: services/notification-service/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
    ports:
      - "8005:8000"
    restart: always
    depends_on:
      - redis

  audit-service:
    build:
      context: .
      dockerfile: services/audit-service/Dockerfile
    environment:
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
    ports:
      - "8006:8000"
    restart: always
    depends_on:
      - postgres

  user-management:
    build:
      context: .
      dockerfile: services/user-management/Dockerfile
    environment:
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
      JWT_SECRET: ${JWT_SECRET:-trinity-secret-key-change-in-production}
    ports:
      - "8007:8000"
    restart: always
    depends_on:
      - postgres

  ml-training:
    build:
      context: .
      dockerfile: services/ml-training/Dockerfile
    ports:
      - "8008:8000"
    restart: always
    volumes:
      - ml-models:/app/models

  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    environment:
      USER_MGMT_URL: http://user-management:8000
      RCA_API_URL: http://rca-api:8000
      INVESTIGATION_URL: http://investigation-api:8000
      VECTOR_SEARCH_URL: http://vector-search:8000
      AUDIT_URL: http://audit-service:8000
      NOTIFICATION_URL: http://notification-service:8000
      ML_TRAINING_URL: http://ml-training:8000
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET:-trinity-secret-key-change-in-production}
    ports:
      - "8000:8000"
    restart: always
    depends_on:
      - redis
      - user-management
      - rca-api
      - investigation-api
      - vector-search
      - audit-service
      - notification-service
      - ml-training

volumes:
  ml-models:
