services:
  nats:
    image: nats:latest
    command: ["-js"]
    ports:
      - "4222:4222"

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: trinity
      POSTGRES_USER: trinity
      POSTGRES_PASSWORD: trinity
    ports:
      - "5432:5432"

  neo4j:
    image: neo4j:5-community
    environment:
      NEO4J_AUTH: neo4j/trinity123
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
    ports:
      - "7474:7474"
      - "7687:7687"
    restart: always

  event-collector:
    build:
      context: .
      dockerfile: services/event-collector/Dockerfile
    environment:
      NATS_URL: nats://nats:4222
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
    ports:
      - "8001:8000"
    restart: always

  kg-projector:
    build:
      context: .
      dockerfile: services/kg-projector/Dockerfile
    environment:
      NATS_URL: nats://nats:4222
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: trinity123
    restart: always

  rca-api:
    build:
      context: .
      dockerfile: services/rca-api/Dockerfile
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: trinity123
    ports:
      - "8002:8000"
    restart: always

  investigation-api:
    build:
      context: .
      dockerfile: services/investigation-api/Dockerfile
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: trinity123
      RCA_API_URL: http://rca-api:8000
    ports:
      - "8003:8000"
    restart: always

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    restart: always

  vector-search:
    build:
      context: .
      dockerfile: services/vector-search/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "8004:8000"
    restart: always
    depends_on:
      - redis

  notification-service:
    build:
      context: .
      dockerfile: services/notification-service/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SMTP_HOST: ${SMTP_HOST:-smtp.gmail.com}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
    ports:
      - "8005:8000"
    restart: always
    depends_on:
      - redis

  audit-service:
    build:
      context: .
      dockerfile: services/audit-service/Dockerfile
    environment:
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
    ports:
      - "8006:8000"
    restart: always
    depends_on:
      - postgres

  user-management:
    build:
      context: .
      dockerfile: services/user-management/Dockerfile
    environment:
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
      JWT_SECRET: ${JWT_SECRET:-trinity-secret-key-change-in-production}
    ports:
      - "8007:8000"
    restart: always
    depends_on:
      - postgres

  ml-training:
    build:
      context: .
      dockerfile: services/ml-training/Dockerfile
    ports:
      - "8008:8000"
    restart: always
    volumes:
      - ml-models:/app/models

  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    environment:
      USER_MGMT_URL: http://user-management:8000
      RCA_API_URL: http://rca-api:8000
      INVESTIGATION_URL: http://investigation-api:8000
      VECTOR_SEARCH_URL: http://vector-search:8000
      AUDIT_URL: http://audit-service:8000
      NOTIFICATION_URL: http://notification-service:8000
      ML_TRAINING_URL: http://ml-training:8000
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET:-trinity-secret-key-change-in-production}
    ports:
      - "8000:8000"
    restart: always
    depends_on:
      - redis
      - user-management
      - rca-api
      - investigation-api
      - vector-search
      - audit-service
      - notification-service
      - ml-training

  agent-orchestrator:
    build:
      context: .
      dockerfile: services/agent-orchestrator/Dockerfile
    environment:
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_MODEL: claude-haiku-4.5-20250514
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
      REDIS_HOST: redis
      REDIS_PORT: 6379
    ports:
      - "8009:8000"
    restart: always
    depends_on:
      - postgres
      - redis

  workflow-engine:
    build:
      context: .
      dockerfile: services/workflow-engine/Dockerfile
    environment:
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
    ports:
      - "8010:8000"
    restart: always
    depends_on:
      - postgres

  data-aggregator:
    build:
      context: .
      dockerfile: services/data-aggregator/Dockerfile
    environment:
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: trinity123
    ports:
      - "8011:8000"
    restart: always
    depends_on:
      - postgres
      - neo4j

  metrics-collector:
    build:
      context: .
      dockerfile: services/metrics-collector/Dockerfile
    environment:
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: trinity123
      REDIS_HOST: redis
      REDIS_PORT: 6379
      METRICS_PORT: 9090
      COLLECT_INTERVAL: 15
    ports:
      - "9090:9090"
    restart: always
    depends_on:
      - postgres
      - neo4j
      - redis

  real-time-processor:
    build:
      context: .
      dockerfile: services/real-time-processor/Dockerfile
    environment:
      NATS_URL: nats://nats:4222
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
      NOTIFICATION_URL: http://notification-service:8000
    restart: always
    depends_on:
      - nats
      - postgres
      - notification-service

  cache-service:
    build:
      context: .
      dockerfile: services/cache-service/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      DEFAULT_TTL: 3600
    ports:
      - "8012:8000"
    restart: always
    depends_on:
      - redis

  alert-manager:
    build:
      context: .
      dockerfile: services/alert-manager/Dockerfile
    environment:
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
      REDIS_HOST: redis
      REDIS_PORT: 6379
      NOTIFICATION_URL: http://notification-service:8000
    ports:
      - "8013:8000"
    restart: always
    depends_on:
      - postgres
      - redis
      - notification-service

  scheduler-service:
    build:
      context: .
      dockerfile: services/scheduler-service/Dockerfile
    environment:
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
      WORKFLOW_ENGINE_URL: http://workflow-engine:8000
      AGENT_ORCHESTRATOR_URL: http://agent-orchestrator:8000
    restart: always
    depends_on:
      - postgres
      - workflow-engine
      - agent-orchestrator

  query-optimizer:
    build:
      context: .
      dockerfile: services/query-optimizer/Dockerfile
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: trinity123
      REDIS_HOST: redis
      REDIS_PORT: 6379
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_MODEL: claude-haiku-4.5-20250514
    ports:
      - "8014:8000"
    restart: always
    depends_on:
      - neo4j
      - redis

  backup-service:
    build:
      context: .
      dockerfile: services/backup-service/Dockerfile
    environment:
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: trinity123
      BACKUP_DIR: /app/backups
      BACKUP_RETENTION_DAYS: 7
    restart: always
    volumes:
      - backups:/app/backups
    depends_on:
      - postgres
      - neo4j

  health-monitor:
    build:
      context: .
      dockerfile: services/health-monitor/Dockerfile
    environment:
      POSTGRES_URL: postgresql://trinity:trinity@postgres:5432/trinity
      REDIS_HOST: redis
      REDIS_PORT: 6379
      ALERT_MANAGER_URL: http://alert-manager:8000
      CHECK_INTERVAL: 30
    restart: always
    depends_on:
      - postgres
      - redis
      - alert-manager

volumes:
  ml-models:
  backups:
